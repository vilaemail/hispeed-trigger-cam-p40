# HiSpeed Trigger Cam P40

Super slow motion capture app for Huawei P40.

## Functionalities

### Capture modes

- Single manual capture by pressing `Capture` button. Captures a 0.5s burst at selected FPS/resolution. Saves to `DCIM/hispeed-trigger-cam/YYYY-MM-DD-HH-MM-SS-SSS_FFFfps.mp4`.
- Externally triggered capture by key `r` from a HID (i.e. USBC connected keyboard). Activated by pressing `Arm` button after which each `r` keypress results in a capture (same as single manual capture). Keypresses while capture/processing is in progress will not result in new capture.

### Resolution, framerate and quality

- Select between 960 FPS 1080p and 1920 FPS 720p.
- Select between 3 engines for capturing video:
    - Huawei CameraKit SDK - the official huawei way of using superslowmotion
    - Patched HwCameraKit - extracted `/system/priv-app/HwCameraKit` patched (to increase bitrate) and integrated into this app.
    - Camera2 Direct - currently disabled as it is not working (needs fixing). Idea is to execute similar code to that of Patched HwCameraKit directly in our code giving us the most flexibility.

### Sending captured data

- Host HTTP server on either port `80` or `8080` for listing captures `/captures` and downloading a capture `/capture/filename.mp4` via HTTP GETs.
- Push all captures to external flash drive (connected via USBC).

## Installing

- Downloading: You may download the APK from [GitHub releases](https://github.com/vilaemail/hispeed-trigger-cam-p40/releases/). For verifying GitHub release you can use the following key: `SHA-256: E9:55:76:8C:6A:86:6A:E7:DE:54:9A:E9:94:AA:35:73:12:6E:CC:92:67:93:04:95:08:F4:94:F8:36:78:E4:5C`
    ```
    apksigner verify --verbose --print-certs <path-to-apk>
    adb install -r -g <path-to-apk>
    ```
- Compiling your own: Clone the repo and build your own apk per instructions below.

## Disclaimer

Most of the code and project was generated by AI tools.

## Contributing

Pull requests are welcome, as long as the main app functionality keeps working and is as simple to use. There is a list of [TODOs](./TODO.md) which you may try to tackle.

## Building the app

### Requirements

- Windows (scripts in `./scripts` folder are for Windows, you could port them to other OS, pull request welcome)
- Huawei P40 Pro (EMUI 10.0+) connected to computer with USB debugging enabled and the computer authorized.
- JDK 17+, Android SDK (API 36)
- Python 3

### Steps

1. After cloning, download the Huawei CameraKit SDK: `scripts\fetch-sdk.bat`
1. Connect device to PC with USB debugging enabled and pull system APK `scripts\pull-hwcamerakit.bat` and then patch it `scripts\patch-hwcamerakit.bat`
1. Build, install on device, run app and show logs in console `scripts\deploy-debug.bat`
1. Create a signed non-versioned APK `scripts\build-release.bat` and install it on device `scripts\install.bat`.
1. Release a version on github `scripts\release.bat vX.Y.Z`

## Scripts

| Script | Description |
|--------|-------------|
| `scripts\fetch-sdk.bat` | Download Huawei CameraKit SDK to `app\libs\` |
| `scripts\build-debug.bat` | Build debug APK |
| `scripts\deploy-debug.bat` | Build + install to USB device + logcat |
| `scripts\build-release.bat` | Build signed release APK to `release\` |
| `scripts\release.bat v1.0.0` | Build + sign + create GitHub release |
| `scripts\install.bat [version]` | Install APK via adb (`latest` or e.g. `v1.0.0`) |
| `scripts\logcat.bat` | View app logs |
| `scripts\pull-hwcamerakit.bat` | Pull HwCameraKit from device, convert to `pull\hwcamerakit.jar` (run once) |
| `scripts\patch-hwcamerakit.bat [bps] [h264\|h265] [cbr]` | Patch bitrate/encoder/CBR in pulled JAR, save to `libs\` (default: 100 Mbps, H.264, VBR) |

## Signing Setup

See [signing/README.md](signing/README.md).

## License

MIT
